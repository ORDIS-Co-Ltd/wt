WT_DECLARE_WT_MEMBER(1,JavaScriptConstructor,"WFileDropWidget",function(k,b,t){jQuery.data(b,"lobj",this);var d=this,q="Wt-dropzone-hover",e=[],r=false,l=true,o=false,p=false,h=undefined,s=0,m=0,j=document.createElement("input");j.type="file";j.setAttribute("multiple","multiple");$(j).hide();b.appendChild(j);var i=document.createElement("div");$(i).addClass("Wt-dropcover");document.body.appendChild(i);this.eventContainsFile=function(a){var c=a.dataTransfer.types!=null&&a.dataTransfer.types.length>
0&&a.dataTransfer.types[0]==="Files";return a.dataTransfer.items!=null&&a.dataTransfer.items.length>0&&a.dataTransfer.items[0].kind==="file"||c};this.validFileCheck=function(a,c,g){var f=new FileReader;f.onload=function(){c(true,g)};f.onerror=function(){c(false,g)};f.readAsText(a.slice(0,32))};b.setAcceptDrops=function(a){l=a};b.setDropIndication=function(a){o=a};b.setDropForward=function(a){p=a};b.ondragenter=function(a){if(l){if(d.eventContainsFile(a)){m===0&&d.setPageHoverStyle();m=2;d.setWidgetHoverStyle(true)}a.stopPropagation()}};
b.ondragleave=function(a){var c=a.clientX;a=a.clientY;var g=document.elementFromPoint(c,a);if(c===0&&a===0)g=null;if(g===i){d.setWidgetHoverStyle(false);m=1}else d.resetDragDrop()};b.ondragover=function(a){a.preventDefault()};bodyDragEnter=function(){if((o||p)&&$(b).is(":visible")){m=1;d.setPageHoverStyle()}};document.body.addEventListener("dragenter",bodyDragEnter);i.ondragover=function(a){a.preventDefault();a.stopPropagation()};i.ondragleave=function(){!l||m!=1||d.resetDragDrop()};i.ondrop=function(a){a.preventDefault();
p?b.ondrop(a):d.resetDragDrop()};b.ondrop=function(a){a.preventDefault();if(l){d.resetDragDrop();window.FormData===undefined||a.dataTransfer.files===null||a.dataTransfer.files.length===0||d.addFiles(a.dataTransfer.files)}};this.addFiles=function(a){for(var c=[],g=0;g<a.length;g++){var f={};f.id=Math.floor(Math.random()*Math.pow(2,31));f.file=a[g];e.push(f);var n={};n.id=f.id;n.filename=f.file.name;n.type=f.file.type;n.size=f.file.size;c.push(n)}k.emit(b,"dropsignal",JSON.stringify(c))};b.addEventListener("click",
function(){if(l){$(j).val("");j.click()}});b.markForSending=function(a){for(var c=0;c<a.length;c++)for(var g=a[c].id,f=0;f<e.length;f++)if(e[f].id===g){e[f].ready=true;break}r||e[0].ready&&d.requestSend()};this.requestSend=function(){if(e[0].skip)d.uploadFinished(null);else{r=true;k.emit(b,"requestsend",e[0].id)}};b.send=function(a,c){upload=e[0];if(upload.file.size>t){k.emit(b,"filetoolarge",upload.file.size);d.uploadFinished(null)}else d.validFileCheck(upload.file,h!=undefined&&c?d.workerSend:d.actualSend,
a)};this.actualSend=function(a,c){if(a){a=new XMLHttpRequest;a.addEventListener("load",d.uploadFinished);a.addEventListener("error",d.uploadFinished);a.addEventListener("abort",d.uploadFinished);a.addEventListener("timeout",d.uploadFinished);a.open("POST",c);e[0].request=a;c=new FormData;c.append("file-id",e[0].id);c.append("data",e[0].file);a.send(c)}else d.uploadFinished(null)};this.workerSend=function(a,c){if(a){h.upload=e[0];h.postMessage({cmd:"send",url:c,upload:e[0],chunksize:s})}else d.uploadFinished(null)};
this.uploadFinished=function(a){if(a!=null&&a.type==="load"&&a.currentTarget.status===200||a===true)k.emit(b,"uploadfinished",e[0].id);e.splice(0,1);if(e[0]&&e[0].ready)d.requestSend();else{r=false;k.emit(b,"donesending")}};b.cancelUpload=function(a){if(e[0]&&e[0].id===a)if(e[0].request)e[0].request.abort();else h.upload===e[0]&&h.postMessage({cmd:"cancel",upload:e[0]});else for(var c=1;c<e.length;c++)if(e[c].id===a)e[c].skip=true};j.onchange=function(){if(l)window.FormData===undefined||this.files===
null||this.files.length===0||d.addFiles(this.files)};this.setPageHoverStyle=function(){if(o||p){$(i).addClass("Wt-dropzone-dragstyle");$(b).addClass("Wt-dropzone-dragstyle");o&&$(b).addClass("Wt-dropzone-indication")}};this.setWidgetHoverStyle=function(a){a?$(b).addClass(q):$(b).removeClass(q)};this.resetDragDrop=function(){$(b).removeClass("Wt-dropzone-indication");$(b).removeClass("Wt-dropzone-dragstyle");$(i).removeClass("Wt-dropzone-dragstyle");d.setWidgetHoverStyle(false);m=0};b.configureHoverClass=
function(a){q=a};b.setFilters=function(a){j.setAttribute("accept",a)};b.setUploadWorker=function(a){if(a&&window.Worker){h=new Worker(a);h.onmessage=function(c){if(c.data.workerfeatures){if(c.data.workerfeatures!=="valid"){b.setUploadWorker(null);k.emit(b,"filternotsupported")}}else d.uploadFinished(c.data)};h.postMessage({cmd:"check"})}else h=undefined};b.setChunkSize=function(a){s=a};b.destructor=function(){document.body.removeEventListener("dragenter",bodyDragEnter);document.body.removeChild(i)}});
